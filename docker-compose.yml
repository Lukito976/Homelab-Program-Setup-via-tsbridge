services:
  tsbridge:
    image: ghcr.io/jtdowney/tsbridge:latest
    container_name: tsbridge
    command: ["-config", "/config/tsbridge.toml"]
    cap_add:
      - NET_ADMIN     # Required: Tailscale needs to manage network interfaces
      - SYS_MODULE    # Required: load kernel modules if needed
    devices:
      - /dev/net/tun:/dev/net/tun   # Required: Tailscale TUN device
    volumes:
      - tsbridge-state:/var/lib/tsbridge
      - /home/lukito/homelab/tsbridge.toml:/config/tsbridge.toml:ro
    restart: unless-stopped
    networks:
      - default
      - nextcloud-aio   # Must be on this network to reach nextcloud-aio-apache by hostname
    depends_on:
      - nextcloud-aio-mastercontainer
      - jellyfin

  nextcloud-aio-mastercontainer:
    image: nextcloud/all-in-one:latest
    container_name: nextcloud-aio-mastercontainer
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - nextcloud_aio_mastercontainer:/mnt/docker-aio-config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      APACHE_PORT: "11000"
      APACHE_IP_BINDING: "0.0.0.0"
      SKIP_DOMAIN_VALIDATION: "true"

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    volumes:
      - /media/media-library:/media
      - /srv/laptop-storage:/laptop-storage
      - jellyfin_config:/config
      - jellyfin_cache:/cache
    networks:
      - default

  samba:
    image: dockurr/samba:latest
    container_name: samba
    restart: unless-stopped
    ports:
      - "445:445"
    volumes:
      - /media/media-library:/external:rw
      - /srv/laptop-storage:/laptop-storage:rw
      - ./smb.conf:/etc/samba/smb.conf:ro
    environment:
      USER: "SAMBA_USERNAME"      # Replace with your desired Samba username
      PASS: "SAMBA_PASSWORD"      # Replace with your desired Samba password
      UID: "1000"
      GID: "1000"

volumes:
  nextcloud_aio_mastercontainer:
    external: true
    name: nextcloud_aio_mastercontainer
  tsbridge-state:
  jellyfin_config:
  jellyfin_cache:

networks:
  # This network is created by Nextcloud AIO on first boot.
  # You MUST create it manually before running docker compose up (see Step 5 in README).
  nextcloud-aio:
    external: true
    name: nextcloud-aio
